# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

variables:
  PlatformToBuild: 'Any CPU'
  CofigurationToBuild: Release
  Version: '1.0.0'


pool:
  vmImage: 'windows-latest'

steps:
- bash: |
    set -x
    ver=$(grep "<Version>.*</Version>" $(Build.SourcesDirectory)/pt.KeePassLibStd/pt.KeePassLibStd.csproj | grep -oP "\d\.\d+\.\d+")
    echo "version: $ver"
    ver="$ver.$(Build.BuildId)"
    if[ "$(Build.SourceBranchName)" != "master"] then
      ver="$ver-Beta$(Rev:.r)"
    fi
    echo "version1: $ver"
    sed -i "s|<Version>.*</Version>|<Version>$ver</Version>|g" $(Build.SourcesDirectory)/pt.KeePassLibStd/pt.KeePassLibStd.csproj
    echo "##vso[task.setvariable variable=Version;isOutput=true]$(ver)"
  displayName: 'Set pt.KeePassLibStd version to $(Version)'

- task: NuGetToolInstaller@1

- task: NuGetCommand@2
  displayName: 'NuGet restore'
  inputs:
    restoreSolution: '**\*.sln'

- task: VSBuild@1
  inputs:
    solution: '**\*.sln'
    platform: '$(PlatformToBuild)'
    configuration: '$(CofigurationToBuild)'

- task: VSTest@2
  inputs:
    testSelector: 'testAssemblies'
    testAssemblyVer2: |
      **\*test*.dll
      !**\*TestAdapter.dll
      !**\obj\**
    searchFolder: '$(System.DefaultWorkingDirectory)'
    uiTests: true

- script: |
    echo Add other tasks to build, test, and deploy your project.
    echo See https://aka.ms/yaml
  displayName: 'Run a multi-line script'
